<!doctype html>
<!-- https://github.com/paulirish/html5-boilerplate/blob/master/index.html -->
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="">

  <!-- encoding must be specified within the first 512 bytes
        www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#charset -->

  <!-- meta element for compatibility mode needs to be before
        all elements except title & meta
        msdn.microsoft.com/en-us/library/cc288325(VS.85).aspx -->
  <!-- Chrome Frame is only invoked if meta element for
        compatibility mode is within the first 1K bytes
        code.google.com/p/chromium/issues/detail?id=23003 -->

  <title>Code Samples - Google Docs Tables</title>
  <meta name="description" content="None">
  <meta name="author" content="Brendan Smith">

  <!--  Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="">

    <!-- Place favicon.ico & apple-touch-icon.png
        in the root of your domain and delete these references -->
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  



<link rel="stylesheet/less" media="all" href="/media/less/site.less"/>
<link rel="stylesheet/less" media="print" href="/media/less/print.less"/>


<script type="text/javascript">
var less = { env: "development" };
</script>

<script src="/media/js/libs/less.js/less-1.1.3.js"></script>





  <!-- All JavaScript at the bottom, except for Modernizr which
        enables HTML5 elements & feature detects -->
    <script src="/media/js/libs/modernizr-1.7.min.js"></script>
      
</head>
<body id="googledoctables">

    <header>
      <!--start header-->
      <div class="container">
        <!--start container-->
        <div class="row">

          <div class="span4">
            <h1><span id="first">brendan</span><span id="last">smith</h1>
            <h3>Full Stack Web Developer</h3>
          </div>

          <div class="span5">
              <nav id="social">
                <ul>
                  <li>
                    <a href="http://www.facebook.com/brendan.smith.9862273" title="Facebook">
                      <img src="/media/images/social/facebook.png" alt="Facebook"/></a>
                  </li>
                  <li>
                    <a href="http://www.linkedin.com/in/blsmth" title="Linked In">
                      <img src="/media/images/social/linkedin.png" alt="Linked In"/></a>
                  </li>
                  <li>
                    <a href="http://www.twitter.com/#/blsmth" title="Twitter">
                      <img src="/media/images/social/twitter.png" alt="Twitter"/></a>
                  </li>
                  <li>
                    <a href="https://github.com/blsmth" title="Github">
                      <img src="/media/images/social/github.png" alt="Github"/></a>
                  </li>
                  <li>
                    <a href="mailto:brendan@thronegroup.com" title="Email">
                      <img src="/media/images/social/mail.png" alt="Email"/></a>
                  </li>
                </ul>
              </nav>
            </div>

          <div class="span5">
            <!--start menu-->
                                              <nav class=main_nav>
    <ul>
                <li>
            <a title="Home Page"
                class="nav home"
                href="/">
                Home
            </a>
        </li>        <li>
            <a title="Resume"
                class="nav"
                href="/resume.html">
                Resume
            </a>
        </li>        <li>
            <a title="About"
                class="nav about"
                href="/about.html">
                About
            </a>
        </li>        <li>
            <a title="Photos"
                class="nav photos"
                href="/photos">
                Photos
            </a>
        </li>    </ul>
</nav>
                           <!--end menu-->
          </div>

      </div>
    </div>
  </div>
      <!--end container-->
  </header>
  <!--end header-->
    <div class="container" id="main">
      <!--start container-->


    <section class="row" id="content">
      <!--start content-->
      <h1>Google Docs Tables</h1>

<p>This code sample shows the pieces of code that come together to allow content editors on NPP's site to include a DataTable (extremely powerful jQuery table library) powered table pulled in directly from Google Docs into publications simply by including the tag {% googledoctable id=3 %} where id is the id of the GoogleDocTable object entered through the Django Admin.</p>

<p>I'll give a brief explanation of each piece of the puzzle.</p>
<p>&nbsp;</p>

<h2>GoogleDocTable class (Django Model)</h2>

<p>First, we have the Django Model that defines our database object that will store the data pulled in from Google.  The user enters a GoogleDocTable object in the back-end of the Django Admin, which is a pretty straight-forward process.  Upon saving the new object, the script will reach out to Google Docs and pull in the spreadsheet based on the key field.  It will then pickle this data and store it for access later.  Orginally the idea was to pull this data from Google each time but this proved to be far too slow and cludgy so I opted to pickle the data and store it locally.</p>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GoogleDocTable</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span><br />    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s">&quot;Title&quot;</span><span class="p">,</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><br />    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">()</span><br />    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="s">&quot;Description&quot;</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><br />    <span class="n">key</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s">&quot;Google Docs Key&quot;</span><span class="p">,</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><br />        <span class="n">help_text</span><span class="o">=</span><span class="s">&quot;Google Docs Key for this spreadsheet.  This can be found  </span><span class="se">\</span><br /><span class="s">        in the URL for your Google Doc&quot;</span><span class="p">)</span><br />    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="s">&quot;Worksheet ID&quot;</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><br />    <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s">&quot;Notes&quot;</span><span class="p">,</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><br />    <span class="n">formatters</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s">&quot;Formatters&quot;</span><span class="p">,</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><br />        <span class="n">help_text</span><span class="o">=</span><span class="s">&quot;Comma seperated list of formatters for this table. </span><span class="se">\</span><br /><span class="s">        (Valid Formatters: full_state,$,%,none - full_state converts from abbreviation to full state name.&quot;</span><span class="p">)</span><br />    <span class="n">datatable_options</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="s">&quot;Datatable Options&quot;</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><br />        <span class="n">help_text</span><span class="o">=</span><span class="s">&quot;Here you can specify options in the form of JSON objects.  See the wiki for more useful info&quot;</span><span class="p">)</span><br />    <span class="n">header</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s">&quot;Header&quot;</span><span class="p">,</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><br />    <span class="n">data</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span><span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><br />    <span class="n">processed</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><br />&nbsp;<br /><br />    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span><br />        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s">&quot;Google Doc Table&quot;</span><br />        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s">&quot;Google Doc Tables&quot;</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">datatable_options_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datatable_options</span><span class="p">)</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; update()</span><br /><span class="sd">        this method updates the table from the Google Docs spreadsheet and stores</span><br /><span class="sd">        the data in a pickled format &#39;&#39;&#39;</span><br />&nbsp;<br />        <span class="c"># grab the spreadsheet from google docs</span><br />        <span class="n">gs</span> <span class="o">=</span> <span class="n">GoogleSpreadsheet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span><span class="n">worksheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">worksheet</span><span class="p">)</span><br />&nbsp;<br />        <span class="k">try</span><span class="p">:</span><br />            <span class="c"># get the tabular data</span><br />            <span class="n">data</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">tabular</span><span class="p">()</span><br />&nbsp;<br />            <span class="c"># grab the header from the first row and pop it</span><br />            <span class="n">header</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><br />            <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><br />&nbsp;<br />            <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><br />            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><br />            <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="bp">False</span><br />            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span><br />            <span class="k">return</span> <span class="bp">True</span><br />        <span class="k">except</span><span class="p">:</span><br />            <span class="k">return</span> <span class="bp">False</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">unpickeled_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; return unpickled data</span><br /><span class="sd">        we need the str() call because of the way Django stores pickled</span><br /><span class="sd">        data in the database &#39;&#39;&#39;</span><br />        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; this method processes data in the format of lists of lists and</span><br /><span class="sd">        updates according to any specified formatters (see formatters field)&#39;&#39;&#39;</span><br />&nbsp;<br />        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><br />        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span><br />            <span class="n">formatters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatters</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span><br />        <span class="n">tmp_data</span> <span class="o">=</span> <span class="p">[]</span><br />        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span><br />            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><br />            <span class="n">tmp_row</span> <span class="o">=</span> <span class="p">[]</span><br />            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span><br />                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><br />                <span class="k">if</span> <span class="n">formatters</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;full_state&#39;</span><span class="p">:</span><br />                    <span class="n">value</span> <span class="o">=</span> <span class="n">state_lookup</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><br />                <span class="k">elif</span> <span class="n">formatters</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;$&quot;</span><span class="p">:</span><br />                    <span class="n">value</span> <span class="o">=</span> <span class="n">currency</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><br />                <span class="k">elif</span> <span class="n">formatters</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;%&quot;</span><span class="p">:</span><br />                    <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%0.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot; %&quot;</span><br />                <span class="n">tmp_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><br />                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span><br />            <span class="n">tmp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_row</span><span class="p">)</span><br />&nbsp;<br />        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">)</span><br />        <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="bp">True</span><br />        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; make sure we pull in data and process if needed &#39;&#39;&#39;</span><br />        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span><br />            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span><br />        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed</span><span class="p">:</span><br />            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">()</span><br />        <span class="nb">super</span><span class="p">(</span><span class="n">GoogleDocTable</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><br /></pre></div><br /><figcaption>tables/models.py</figcaption></figure></div>


<p>&nbsp;</p>

<h2>GoogleSpreadsheet class</h2>
<p>This class is the real meat of what's happening here.  It's a very thin wrapper over the somewhat convoluted GData API from Google to reach out to their service and pull in data from their Google Docs service.

<p>I started in on this class/module with the intention of turning it into a full fledged API to talk to the Google Docs service, but time did not permit.  The spreadsheet class is very functional however and has proved very useful for NPP.</p>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">gdata.spreadsheet.service</span><br /><span class="kn">import</span> <span class="nn">gdata.service</span><br /><span class="kn">import</span> <span class="nn">gdata.spreadsheet</span><br />&nbsp;<br /><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span><br /><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">lazyprop</span> <span class="c"># lazy property evaluation</span><br />&nbsp;<br /><span class="n">GOOGLE_DOCS_USER</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;GOOGLE_DOCS_USER&#39;</span><span class="p">)</span><br /><span class="n">GOOGLE_DOCS_PASSWORD</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;GOOGLE_DOCS_PASSWORD&#39;</span><span class="p">)</span><br />&nbsp;<br /><span class="k">class</span> <span class="nc">GoogleSpreadsheet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><br />    <span class="sd">&#39;&#39;&#39; An iterable google spreadsheet object.  Each row is a dictionary</span><br /><span class="sd">    with an entry for each field, keyed by the header.</span><br /><span class="sd">    requires GData module from google .&#39;&#39;&#39;</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">worksheet</span><span class="o">=</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">GOOGLE_DOCS_USER</span><span class="p">,</span><br />        <span class="n">password</span><span class="o">=</span><span class="n">GOOGLE_DOCS_PASSWORD</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span><br />        <span class="n">service</span> <span class="o">=</span> <span class="n">gdata</span><span class="o">.</span><span class="n">spreadsheet</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">SpreadsheetsService</span><span class="p">()</span><br />        <span class="n">service</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><br />        <span class="n">service</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span><br />        <span class="n">service</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span><br />&nbsp;<br />        <span class="c"># authenticate with google</span><br />        <span class="n">service</span><span class="o">.</span><span class="n">ProgrammaticLogin</span><span class="p">()</span><br />&nbsp;<br />        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span><br />        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><br />        <span class="bp">self</span><span class="o">.</span><span class="n">worksheet</span> <span class="o">=</span> <span class="n">worksheet</span><br />        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><br />&nbsp;<br /><br />    <span class="c"># these next properties are loaded lazily to avoid uneeded</span><br />    <span class="c"># heavy calls to Google on big spreadsheets</span><br />    <span class="nd">@lazyprop</span><br />    <span class="k">def</span> <span class="nf">cell_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; representation of GData&#39;s CellsFeed &#39;&#39;&#39;</span><br />        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">GetCellsFeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worksheet</span><span class="p">)</span><br />&nbsp;<br />    <span class="nd">@lazyprop</span><br />    <span class="k">def</span> <span class="nf">list_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; representation of GData&#39;s ListFeed &#39;&#39;&#39;</span><br />        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">GetListFeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worksheet</span><span class="p">)</span><br />&nbsp;<br />    <span class="nd">@lazyprop</span><br />    <span class="k">def</span> <span class="nf">col_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; column count &#39;&#39;&#39;</span><br />        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_feed</span><span class="o">.</span><span class="n">col_count</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><br />    <span class="nd">@lazyprop</span><br />    <span class="k">def</span> <span class="nf">row_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; row count &#39;&#39;&#39;</span><br />        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_feed</span><span class="o">.</span><span class="n">row_count</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><br />&nbsp;<br />    <span class="nd">@lazyprop</span><br />    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; returns a list of dictionary representations of each row &#39;&#39;&#39;</span><br />        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span><br />        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_feed</span><span class="o">.</span><span class="n">entry</span><span class="p">:</span><br />            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span><br />            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">custom</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span><br />                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">custom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><br />            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><br />        <span class="k">return</span> <span class="n">rows</span><br />&nbsp;<br /><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">tabular</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; return rows a list of lists</span><br /><span class="sd">        useful for outputting directly to html tables &#39;&#39;&#39;</span><br />        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span><br />        <span class="n">cur_row</span> <span class="o">=</span> <span class="mi">1</span><br />        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><br />        <span class="k">while</span> <span class="n">cur_row</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_count</span><span class="p">:</span><br />            <span class="n">cur_col</span> <span class="o">=</span> <span class="mi">1</span><br />            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span><br />            <span class="k">while</span> <span class="n">cur_col</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_count</span><span class="p">:</span><br />                <span class="k">try</span><span class="p">:</span><br />                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_feed</span><span class="o">.</span><span class="n">entry</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><br />                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span><br />                    <span class="c"># empty cells</span><br />                    <span class="k">pass</span><br />                <span class="n">cur_col</span> <span class="o">+=</span> <span class="mi">1</span><br />                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><br />            <span class="n">cur_row</span> <span class="o">+=</span> <span class="mi">1</span><br />            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><br />            <span class="k">del</span> <span class="n">row</span><br />        <span class="k">return</span> <span class="n">rows</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span><br />            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><br />            <span class="k">raise</span> <span class="ne">StopIteration</span><br />        <span class="k">else</span><span class="p">:</span><br />            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><br />            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">insert_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_data</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; insert a row into document.</span><br /><span class="sd">        must be in the form of a dictionary &#39;&#39;&#39;</span><br />        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">InsertRow</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span><br />            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worksheet</span><span class="p">)</span><br />        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">gdata</span><span class="o">.</span><span class="n">spreadsheet</span><span class="o">.</span><span class="n">SpreadsheetsList</span><span class="p">):</span><br />            <span class="k">print</span> <span class="s">&#39;Successfully Inserted&#39;</span><br />        <span class="k">else</span><span class="p">:</span><br />            <span class="k">print</span> <span class="n">entry</span><br />&nbsp;<br /><br />    <span class="c"># override some built-ins</span><br />    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; allow rows to be accessed directly &#39;&#39;&#39;</span><br />        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; allow to call len() on object &#39;&#39;&#39;</span><br />        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span><br /></pre></div><br /><figcaption>utils/googletools.py</figcaption></figure></div>


<p>&nbsp;</p>

<h2>Template Tag</h2>
<p>This is template tag built on top of the fabulous django-classytags library that allows for easy creation of class based tags.  The tag can take one of two arguments: <em>id</em> and <em>slug</em>. the useage of this tag would simply be:
    <div class="codebox"><figure class="code"><div class="highlight"><pre>{% load table_tags %}<br />    {% googledoctable id=3 %} or {% googledoctable slug=&#39;some-really-cool-table&#39; %}<br /></pre></div><br /><figcaption>HTML</figcaption></figure></div>

</p>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span><br /><span class="kn">from</span> <span class="nn">tables.models</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">GoogleDocTable</span><br /><span class="kn">from</span> <span class="nn">classytags.core</span> <span class="kn">import</span> <span class="n">Options</span><br /><span class="kn">from</span> <span class="nn">classytags.arguments</span> <span class="kn">import</span> <span class="n">MultiKeywordArgument</span><br /><span class="kn">from</span> <span class="nn">classytags.helpers</span> <span class="kn">import</span> <span class="n">InclusionTag</span><br />&nbsp;<br /><span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span><br />&nbsp;<br /><span class="k">class</span> <span class="nc">GoogleDocTableTag</span><span class="p">(</span><span class="n">InclusionTag</span><span class="p">):</span><br />    <span class="n">name</span><span class="o">=</span><span class="s">&#39;googledoctable&#39;</span><br />    <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;tables/googledoctable.html&#39;</span><br />    <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><br />        <span class="n">MultiKeywordArgument</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;_kwargs&quot;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><br />    <span class="p">)</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_kwargs</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; find table via slug or id &#39;&#39;&#39;</span><br />        <span class="n">slug</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;slug&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><br />        <span class="nb">id</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><br />&nbsp;<br />        <span class="k">if</span> <span class="n">slug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span><br />            <span class="n">table</span> <span class="o">=</span> <span class="n">GoogleDocTable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span><br />        <span class="k">elif</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span><br />            <span class="k">try</span><span class="p">:</span><br />                <span class="n">table</span> <span class="o">=</span> <span class="n">GoogleDocTable</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><br />            <span class="k">except</span><span class="p">:</span><br />                <span class="n">table</span> <span class="o">=</span> <span class="bp">None</span><br />        <span class="k">return</span> <span class="n">table</span><br />&nbsp;<br />    <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">_kwargs</span><span class="p">):</span><br />        <span class="sd">&#39;&#39;&#39; load table into context &#39;&#39;&#39;</span><br />        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">)</span><br />        <span class="n">header</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">header</span><span class="p">))</span><br />        <span class="n">context</span><span class="o">.</span><span class="n">push</span><span class="p">()</span><br />        <span class="n">context</span><span class="p">[</span><span class="s">&#39;table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><br />        <span class="n">context</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><br />        <span class="n">context</span><span class="p">[</span><span class="s">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><br />        <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><br />        <span class="k">return</span> <span class="n">context</span><br />&nbsp;<br /><span class="n">register</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">GoogleDocTableTag</span><span class="p">)</span><br /></pre></div><br /><figcaption>tables/templatetags/tables_tags.py</figcaption></figure></div>


<p>&nbsp;</p>
<h2>Django Template</h2>
<p>This is the Django Template that is loaded via the InclusionTag seen above. This code simply takes the GoogleDocTable object and converts it to a proper html table.  Then some jQuery magic is applied via the DataTable package and you have a beautiful looking table.  I messed around with DataTable's json loading features but in the end decided it was best to display a traditional html table so anyone not running Javascript would still be able to see the old fashioned html table.</p>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">load</span> <span class="nv">sekizai_tags</span> <span class="nv">tables_tags</span> <span class="nv">humanize</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">&lt;div id=&quot;</span><span class="cp">{{</span> <span class="nv">table.slug</span> <span class="cp">}}</span><span class="x">&quot; name=&quot;</span><span class="cp">{{</span> <span class="nv">table.slug</span> <span class="cp">}}</span><span class="x">&quot; class=&quot;datatable&quot;&gt;</span><br /><span class="x">&lt;h2 class=&quot;tablesorter-title&quot;&gt;</span><span class="cp">{{</span> <span class="nv">table.title</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span><br /><span class="x">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">table.description</span><span class="o">|</span><span class="nf">safe</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span><br /><span class="x">    &lt;table id=&quot;</span><span class="cp">{{</span> <span class="nv">table.slug</span> <span class="cp">}}</span><span class="x">-datatable&quot; class=&quot;tablesorter&quot;&gt;</span><br /><span class="x">        &lt;thead&gt;</span><br /><span class="x">        &lt;tr&gt;</span><br /><span class="x">            </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">column</span> <span class="k">in</span> <span class="nv">header</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">            &lt;th&gt;</span><span class="cp">{{</span> <span class="nv">column</span> <span class="cp">}}</span><span class="x">&lt;/th&gt;</span><br /><span class="x">            </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">        &lt;/tr&gt;</span><br /><span class="x">        &lt;/thead&gt;</span><br />&nbsp;<br /><span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">row</span> <span class="k">in</span> <span class="nv">data</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">        &lt;tr&gt;</span><br /><span class="x">            </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">v</span> <span class="k">in</span> <span class="nv">row</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">            &lt;td&gt;</span><span class="cp">{{</span> <span class="nv">v</span><span class="o">|</span><span class="nf">intcomma</span> <span class="cp">}}</span><span class="x">&lt;/td&gt;</span><br /><span class="x">            </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">        &lt;/tr&gt;</span><br /><span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">    &lt;/table&gt;</span><br /><span class="x">&lt;/div&gt;</span><br />&nbsp;<br /><br /><span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s1">&#39;js&#39;</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">&lt;script type=&quot;text/javascript&quot; src=&quot;</span><span class="cp">{{</span> <span class="nv">STATIC_URL</span> <span class="cp">}}</span><span class="x">datatables/js/jquery.dataTables.js&quot;&gt;&lt;/script&gt;</span><br /><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span><span class="x"></span><br />&nbsp;<br /><span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s1">&#39;js_code&#39;</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">table_list = [];</span><br /><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span><span class="x"></span><br />&nbsp;<br /><span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s1">&#39;js_code&#39;</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">table_list.push({&#39;title&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">table.title</span><span class="o">|</span><span class="nf">escapejs</span> <span class="cp">}}</span><span class="x">&#39;,&#39;slug&#39;: &#39;</span><span class="cp">{{</span> <span class="nv">table.slug</span> <span class="cp">}}</span><span class="x">&#39;});</span><br /><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span><span class="x"></span><br />&nbsp;<br /><br /><span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s1">&#39;document_ready&#39;</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">    $(&#39;#</span><span class="cp">{{</span> <span class="nv">table.slug</span> <span class="cp">}}</span><span class="x">-datatable&#39;).dataTable({</span><br /><span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">table.datatable_options</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">        </span><span class="cp">{{</span> <span class="nv">table.datatable_options</span><span class="o">|</span><span class="nf">safe</span> <span class="cp">}}</span><span class="x">,</span><br /><span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span><br /><span class="x">         &quot;sPaginationType&quot;: &quot;full_numbers&quot;</span><br /><span class="x">    });</span><br /><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span><span class="x"></span><br /></pre></div><br /><figcaption>Django Template</figcaption></figure></div>




<p>&nbsp;</p>
<h2>Working Example</h2>
<p>You can see a working example of this code at the page:<br/> <a href="http://nationalpriorities.org/en/analysis/2012/presidents-budget-fy2013/federal-spending-your-state/" target="_blank">http://nationalpriorities.org/en/analysis/2012/presidents-budget-fy2013/federal-spending-your-state/</a></p>
<p>All of the fancy tables on this page were created with the code I've outlined here.</p>



<p>&nbsp;</p>
<h2>Conclusion</h2>
<p>I chose this as one of my code samples because it shows a few different pieces of code in different places that come together to form a really useful and elegant solution.  The use of these tables and the GoogleSpreadsheet class have proved extremely valuable for NPP.</p>
<p>If you have any questions about this code, please feel free to contact me.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>



    </section>
       <!--end content-->

   </div>
   <!--end container-->

   <!--start footer-->
   <footer>
      <div class="container">
        <div class="row">
           <div class="span16" id="powered-by">
              Powered by <a href="http://hyde.github.com">hyde</a>. Styled with <a href="http://lesscss.org/" title="LESS">LESS</a>. Hosted on <a href="http://github.com/" title="Github.com">Github.com</a>.
            </div>
        </div>
      </div>
   </footer>
   <!--end footer-->

   <!-- Javascript at the bottom for fast page loading -->
    <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
  <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.2.min.js">\x3C/script>')</script>
  
    


      
  </body>
</html>